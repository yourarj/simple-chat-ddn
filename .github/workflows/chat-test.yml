name: chat ci

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: 1.91.1

jobs:
  test-chat:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ env.RUST_VERSION }}
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
        
    - name: Check formatting
      run: |
        cargo fmt --all -- --check
        
    - name: Check for clippy
      run: |
        cargo clippy --workspace --all-targets --all-features -- -D warnings
        
    - name: Run all tests
      run: |
        cargo test --all
        
    - name: Build the project
      run: |
        cargo build --workspace
        
    - name: Verify binaries can be executed
      run: |
        ./target/debug/chat-server --help
        ./target/debug/chat-client --help
        
    - name: Start chat server
      run: |
        nohup cargo run --bin chat-server -- --host 127.0.0.1 --port 8080 --max-connections 100 > server.log 2>&1 &
        SERVER_PID=$!
        
        # save the server PID for cleanup in later phase
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # Wait a moment for the server to start (technically not required as it's rust ðŸ˜‰)
        sleep 3
        
        # Check if server is running and listening on the port
        if kill -0 $SERVER_PID 2>/dev/null; then
          echo "Server started successfully with PID $SERVER_PID"
          if lsof -i :8080 >/dev/null 2>&1; then
            echo "Server is listening on port 8080"
          else
            echo "Server is not listening on port 8080"
            cat server.log
            exit 1
          fi
        else
          echo "Server failed to start"
          cat server.log
          exit 1
        fi
        
    - name: Test client connection and message sending
      run: |
        echo "Testing first client connection..."
        {
          echo "send Hello from test client"
          echo "leave"
        } | cargo run --bin chat-client -- --host 127.0.0.1 --port 8080 --username testuser1
        
        echo "Testing second client connection..."
        {
          echo "send Hello from second client"
          echo "leave"
        } | cargo run --bin chat-client -- --host 127.0.0.1 --port 8080 --username testuser2
        
        # Test 3: Test username collision detection
        echo "Testing username collision..."
        {
          echo "send Message from duplicate user"
          echo "leave"
        } | cargo run --bin chat-client -- --host 127.0.0.1 --port 8080 --username testuser1 &
        
        sleep 1
        wait
        
        echo "Everything is fine"
        
    - name: Stop chat server
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID
          wait $SERVER_PID 2>/dev/null || true
          echo "server stopped"
          
          echo "=== Server Logs ==="
          cat server.log
          echo "=== End Server Logs ==="
        fi
        
    - name: Verify no processes left running
      run: |
        if command -v lsof >/dev/null 2>&1; then
          if lsof -i :8080 >/dev/null 2>&1; then
            echo "Warning: Port 8080 still in use after server shutdown"
            lsof -i :8080
            exit 1
          else
            echo "Port 8080 is free"
          fi
        else
          echo "lsof not available, skipping port check"
        fi

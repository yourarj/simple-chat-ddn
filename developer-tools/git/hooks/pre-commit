#!/bin/bash

set -e

echo "ğŸ” Running pre-commit checks ..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

# Check if rust is installed
if ! command -v cargo &> /dev/null; then
    print_error "Cargo/Rust not found. Please install Rust: https://rustup.rs/"
    exit 1
fi

# Get list of staged Rust files
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)

if [ -z "$RUST_FILES" ]; then
    print_warning "No Rust files staged for commit"
    exit 0
fi

echo "ğŸ“ Staged Rust files:"
echo "$RUST_FILES" | sed 's/^/  /'

# Check formatting
echo ""
echo "ğŸ”¤ Checking code formatting..."
if ! cargo fmt --all -- --check; then
    print_error "Code formatting issues found. Run 'cargo fmt --all' to fix them."
    echo ""
    echo "ğŸ’¡ To automatically format your code:"
    echo "   cargo fmt --all"
    exit 1
fi
print_status "Code formatting is correct"

# Check for compilation errors
echo ""
echo "ğŸ”¨ Checking compilation..."
if ! cargo check --all --all-features; then
    print_error "Compilation failed. Please fix compilation errors."
    exit 1
fi
print_status "Code compiles successfully"

# Run clippy for linting
echo ""
echo "ğŸ” Running clippy linter..."
if ! cargo clippy --workspace --all-targets --all-features -- -D warnings; then
    print_error "Clippy found issues. Please fix them or use 'allow' if appropriate."
    echo ""
    echo "ğŸ’¡ To see clippy suggestions:"
    echo "   cargo clippy --all --all-features"
    exit 1
fi
print_status "No clippy issues found"

# Run basic tests on changed files
echo ""
echo "ğŸ§ª Running tests..."
if ! cargo test --all --all-features; then
    print_error "Tests failed. Please fix failing tests."
    exit 1
fi
print_status "All tests pass"
exit 0
